<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Profil Client</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="../css/style.css">
        <link rel="stylesheet" type="text/css" href="../css/profilClient.css">
        <script src="https://kit.fontawesome.com/cf7a3548ef.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <nav class='navbar'>
            <a href='index.html'><img src='../resources/img/blue_logo.png' alt='small_logo' class='navLogo'/></a>
            <a class='mediumText blue bold navItem'>Employé</a>
        </nav>
        <div class='content purple'>
            <div class='profilContainer lightBlueBack'>
                <div class='profilHeader bigText'><a href='travail.html' class='backLink'><i class="fas fa-angle-left purple"></i></a><span id='nomClient'></span><div></div></div>
                <div class='cardContainer'>
                    <div class='card'>
                        <div class='cardTitle mediumText'>Profil Zodiaque</div>
                        <hr class='purple cardDivider'/>
                        <div class='cardData'>
                            Signe du zodiaque : <span id='signeZodiaque'></span>
                        </div>
                        <div class='cardData'>
                            Signe astrologique chinois : <span id='signeChinois'></span>
                        </div>
                        <div class='cardData'>
                            Couleur porte-bonheur : <span id='couleur'></span>
                        </div>
                        <div class='cardData'>
                            Animal totem : <span id='animalTotem'></span>
                        </div>
                    </div>
                    <div class='card' id='consultationCard'>
                        <div class='cardTitle mediumText' id='consultationCardTitle'>
                            <span id='commencerTitle'>Commencer Consultation</span>
                            <i class="fas fa-plus purple commencerConsultationBtn" onclick='commencerConsultation()'></i>
                        </div>
                        
                    </div>
                    <div class='card'>
                        <div class='cardTitle mediumText'>
                            Historique des consultation
                        </div>
                        <hr class='purple cardDivider'/>
                        <div class='historyContainer' id='historyContainer'>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            
            $(document).ready( function () {
                getConsultationData();
            });
            
            let consultationHtml = "<hr class='purple cardDivider'/> <div class='cardData'> Durée : <span id='consultationDuration'></span> </div> <div class='subcard'> <div class='subcardTitle'>Prédiction Automatique</div> <hr class='purple cardDivider'/> <div class='cardData predictionInputContainer'> <input type='text' class='predictionInput' id='amour' placeholder='Amour'> <input type='text' class='predictionInput' id='sante' placeholder='Santé'> <input type='text' class='predictionInput' id='travail' placeholder='Travail'> <button class='fullBtnPurple fullBlueHover calculateBtn'>Calculer <i class='fas fa-arrow-down'></i></button> </div> <textarea class='cardTextarea' readonly></textarea> </div> <div class='subcard'> <div class='subcardTitle'>Commentaires</div> <hr class='purple cardDivider'/> <textarea class='cardTextarea commentArea'></textarea> </div>";
            
            function commencerConsultation() {
                $('#consultationCard').append(consultationHtml);
                $('#consultationCardTitle').html("Consultation comme *nom-médium*");
            }
            
            function toggleHistoryExpand(id) {
                let elem = $('#historyEntry'+id);
                let elemBtn = $('#historyEntryBtn'+id);
                
                if(elem.attr('expanded') === 'true') {
                    elem.html("");
                    elem.attr('expanded', 'false');
                    elemBtn.removeClass('fa-angle-up');
                    elemBtn.addClass('fa-angle-down');
                } else {
                    let comment = historiqueCommentsMap.get(id);
                    
                    elem.append("<hr class='purple cardDivider'/><div>" + (comment === null ? "Aucun commantaire" : comment) + "</div>");
                    elem.attr('expanded', 'true');
                    elemBtn.removeClass('fa-angle-down');
                    elemBtn.addClass('fa-angle-up');
                }
            }
            
            function getConsultationData() {
                $.ajax({
                        url: '../ActionServlet',
                        method: 'GET',
                        data: {
                            todo: 'getDonneesConsultation'
                        },
                        dataType: 'json'
                    })
                    .done( function (response) { // Fonction appelée en cas d'appel AJAX réussi
                        console.log(response);
                        if(response && response.connexion && response.client 
                                && response.historique && response.profilAstral) {
                            let client = response.client;
                            let historiqueArray = response.historique;
                            let profilAstral = response.profilAstral;
                            
                            displayConsultationData(client, historiqueArray, profilAstral);
                        } else {
                            
                        }
                    })
                    .fail( function (error) { // Fonction appelée en cas d'erreur lors de l'appel AJAX
                        console.log('Error',error); // LOG dans Console Javascript
                        alert("Erreur lors de l'appel AJAX");
                    })
                    .always( function () { // Fonction toujours appelée
                        
                });
            }
            
            // This map will associate each historiqueEntry with its comment,
            // using it's index in the historique array in response as key.
            let historiqueCommentsMap = new Map();
            
            function displayConsultationData(client, historiqueArray, profilAstral) {
                $('#nomClient').html(client.prenom + " " + client.nom);
                
                $('#signeZodiaque').html(profilAstral.signeZodiaque);
                $('#signeChinois').html(profilAstral.signeChinois);
                $('#couleur').html(profilAstral.couleur);
                $('#animalTotem').html(profilAstral.animalTotem);
                
                let historiqueContainerElem = $('#historyContainer');
                historiqueArray.forEach((entry, index) => {
                    let entryHtml = "<div class='historyEntry' onclick='toggleHistoryExpand(" + index + ")'><div class='historyTitle'><span>" + "03/12/1998" + "</span><span> " + entry.medium + "</span><div class='dropdownBtn'><i class='fas fa-angle-down purple' id='historyEntryBtn" + index + "'></i></div></div><span id='historyEntry" + index + "'></span></div>";
                    historiqueCommentsMap.set(index, entry.commentaire);
                    historiqueContainerElem.append(entryHtml);
                });
            }
            
        </script>
    </body>
</html>
